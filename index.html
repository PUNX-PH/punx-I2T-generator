<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Image to Video Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --neon-blue: #00e5ff;
      --deep-purple: #1b0031;
      --flame-orange: #ff6e00;
      --light-bg: #f4f4f4;
      --light-panel: #fff;
      --dark-bg: #0a0a12;
      --dark-panel: #1b1b2d;
      --text-light: #eee;
      --text-dark: #333;
    }
    [data-theme="dark"] {
      background: var(--dark-bg);
      color: var(--text-light);
    }
    [data-theme="dark"] .container {
      background: var(--dark-panel);
      color: var(--text-light);
    }
    body {
      margin: 0; padding: 20px;
      font-family: 'Montserrat', sans-serif;
      background: var(--light-bg);
      color: var(--text-dark);
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 700px; margin: auto;
      background: var(--light-panel);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      transition: background 0.3s;
    }
    header { display: flex; justify-content: space-between; align-items: center; }
    header button { background: transparent; border: 2px solid var(--neon-blue); color: var(--neon-blue); padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    header button:hover { background: var(--neon-blue); color: var(--dark-bg); }
    label { display: block; margin-top: 20px; font-weight: 600; }
    input, select, textarea, button {
      width: 100%; margin-top: 8px; padding: 14px; border-radius: 6px;
      border: 1px solid #555; font-size: 15px;
      background: transparent; color: inherit;
    }
    button.submit {
      background: var(--flame-orange); color: #fff; border: none;
      cursor: pointer; font-weight: 600; margin-top: 25px;
      transition: background 0.3s;
    }
    button.submit:hover { background: #e65500; }
    img, video { width: 100%; border-radius: 8px; margin-top: 12px; }
    .video-item { margin-top: 30px; padding-top: 20px; border-top: 1px solid #444; position: relative; }
    .status { font-style: italic; color: var(--text-light); }
    .spinner { width: 18px; height: 18px; border: 3px solid var(--flame-orange); border-top: 3px solid var(--neon-blue); border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .progress-bar { height: 6px; background: var(--neon-blue); width: 0%; border-radius: 4px; margin-top: 8px; transition: width 0.5s; }
    .toast { position: fixed; bottom: 30px; right: 30px; background: var(--neon-blue); color: var(--dark-bg); padding: 14px 22px; border-radius: 6px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s, transform 0.3s; z-index: 999; }
    .toast.show { opacity:1; transform: translateY(0); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h2>ðŸŽ¬ Image â†’ Video Gener8tor</h2>
      <button id="themeToggle">Toggle Dark Mode</button>
    </header>
    <label>Upload Image<input type="file" id="imageInput" accept="image/*"/></label>
    <img id="previewImage" style="display:none;"/>
    <label>Runpod ID<input type="text" id="runpodIdInput" placeholder="Enter runpod ID"/></label>
    <label>Prompt<textarea id="promptInput">Make the person in the image fly up into the sky...</textarea></label>
    <label>Negative Prompt<textarea id="negativePromptInput">bad anatomy, blurry, multiple heads</textarea></label>
    <label>Duration<select id="durationInput"><option value="5">5 seconds</option><option value="10">10 seconds</option></select></label>
    <button class="submit" onclick="handleSubmit()">Generate Video</button>

    <h3>In Queue</h3><div id="inProgressList"></div>
    <h3>Completed</h3><div id="videoList"></div>
  </div>
  <div id="toast" class="toast"></div>

<script>
  document.body.setAttribute('data-theme','light');
  document.getElementById('themeToggle').onclick = ()=>{
    const cur = document.body.getAttribute('data-theme');
    document.body.setAttribute('data-theme', cur==='light'?'dark':'light');
  };
  const toast = document.getElementById('toast');
  function showToast(msg,d=3000){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),d);}

  document.getElementById("imageInput").addEventListener("change", e=>{
    const file = e.target.files[0];
    if(file){
      const r=new FileReader();
      r.onload = ev => { const img=document.getElementById("previewImage"); img.src=ev.target.result; img.style.display='block'; };
      r.readAsDataURL(file);
    }
  });

  let uploadedFilename;
  async function uploadImage(id,file){
    const fd=new FormData(); fd.append('file',file); fd.append('runpod_id',id);
    try {
      const resp=await fetch("/api/upload",{method:'POST',body:fd});
      const d=await resp.json();
      if(resp.ok && d.filename){uploadedFilename=d.filename; showToast('Image uploaded'); return true;}
      showToast('Upload failed'); return false;
    } catch(e){ showToast('Upload error'); return false;}
  }

  async function createTask(prompt,neg,id,dur){
    const body={prompt,prompt:prompt,negative_prompt:neg,input_image:uploadedFilename,runpod_id:id,duration:parseInt(dur)};
    try {
      const resp=await fetch("/api/create-task",{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const d=await resp.json();
      if(resp.ok && d.task_id){ showToast('Task created'); return d;}
      showToast('Task creation failed'); return {};
    } catch(e){ showToast('Error creating task'); return {}; }
  }

  async function checkTask(taskId,runpodId,container,bar){
    try {
      const resp=await fetch(`/api/get-task?taskId=${taskId}&runpod_id=${runpodId}`);
      const d=await resp.json();
      if(d.status==='Complete'){
        container.querySelector('.status').textContent = 'âœ… Complete';
        const thumb = document.createElement('img'); thumb.src = d.thumbnail_url; container.appendChild(thumb);
        container.innerHTML += `<video controls src="${d.video_url}"></video><a href="${d.video_url}" download>Download</a>`;
        document.getElementById('videoList').prepend(container);
      }
      return d;
    } catch(e){ return {status:'Error'};}
  }

  function handleSubmit(){
    const file=document.getElementById("imageInput").files[0];
    const runpodId=document.getElementById("runpodIdInput").value;
    const prompt=document.getElementById("promptInput").value;
    const neg=document.getElementById("negativePromptInput").value;
    const dur=document.getElementById("durationInput").value;
    if(!file||!runpodId){ showToast('Upload image & enter ID'); return;}
    uploadImage(runpodId,file).then(ok=>{
      if(ok) createTask(prompt,neg,runpodId,dur).then(d=>{
        if(d.task_id){
          const list=document.getElementById("inProgressList");
          const c=document.createElement('div'); c.className='video-item'; c.id=`task-${d.task_id}`;
          c.innerHTML=`<p class="status"><span class="spinner"></span> Generatingâ€¦ TaskID: ${d.task_id}</p><div class="progress-bar" id="p-${d.task_id}"></div>`;
          list.prepend(c); pollTask(d.task_id,runpodId,c);
        }else showToast('No task ID returned');
      });
    });
  }

  function pollTask(tid,id,container){
    let prog=0;
    const bar = container.querySelector(`#p-${tid}`);
    const iv=setInterval(async ()=>{
      prog = Math.min(prog+8,95);
      bar.style.width = prog+'%';
      const res = await checkTask(tid,id,container,bar);
      if(res.status==='Complete'){ clearInterval(iv); bar.style.width='100%'; }
    },5000);
  }
</script>
</body>
</html>
