<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image to Video Generator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input, select, textarea, button { width: 100%; margin-top: 10px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { background-color: #007BFF; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    video { width: 100%; margin-top: 10px; }
    .video-item { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Image to Video Generator</h2>
    <label>Upload Image</label>
    <input type="file" id="imageInput" accept="image/*">
    <label>Runpod ID</label>
    <input type="text" id="runpodIdInput" placeholder="Enter runpod ID">

    <label>Prompt</label>
    <textarea id="promptInput">Make the person in the image fly up into the sky, passing through clouds with wind blowing around them.</textarea>
    <label>Negative Prompt</label>
    <textarea id="negativePromptInput">bad anatomy, blurry, multiple heads</textarea>

    <label>Duration</label>
    <select id="durationInput">
      <option value="5">5 seconds</option>
      <option value="10">10 seconds</option>
    </select>

    <button onclick="handleSubmit()">Generate Video</button>

    <div id="videoList"></div>
  </div>

  <script>
    let uploadedFilename = "";
    let currentTaskId = "";

    async function uploadImage(runpodId, file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("runpod_id", runpodId);

      const response = await fetch("https://punx-i2-t-generator.vercel.app/api/upload", {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      if (response.ok && data.filename) {
        uploadedFilename = data.filename;
        return true;
      }
      alert("Image upload failed.");
      return false;
    }

    async function createTask(prompt, negativePrompt, runpodId, duration) {
      const response = await fetch("https://punx-i2-t-generator.vercel.app/api/upload", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt, negative_prompt: negativePrompt, input_image: uploadedFilename, runpod_id: runpodId, duration })
      });
      const data = await response.json();
      currentTaskId = data.taskId;
      return data;
    }

    async function checkTask(taskId, runpodId) {
      const res = await fetch(`https://punx-i2-t-generator.vercel.app/api/get-task?taskId=${taskId}&runpod_id=${runpodId}`);
      return await res.json();
    }

    function handleSubmit() {
      const imageFile = document.getElementById("imageInput").files[0];
      const runpodId = document.getElementById("runpodIdInput").value;
      const prompt = document.getElementById("promptInput").value;
      const negativePrompt = document.getElementById("negativePromptInput").value;
      const duration = document.getElementById("durationInput").value;

      if (!imageFile || !runpodId) {
        alert("Please upload an image and enter a runpod ID.");
        return;
      }

      uploadImage(runpodId, imageFile).then(success => {
        if (success) {
          createTask(prompt, negativePrompt, runpodId, duration).then(task => {
            if (task.taskId) {
              pollTask(task.taskId, runpodId);
            } else {
              alert("Failed to create task.");
            }
          });
        }
      });
    }

    function pollTask(taskId, runpodId) {
      const interval = setInterval(async () => {
        const result = await checkTask(taskId, runpodId);
        if (result.status === "Complete") {
          clearInterval(interval);
          displayVideo(result.video_url);
        } else {
          console.log("Checking task status: " + result.status);
        }
      }, 5000);
    }

    function displayVideo(url) {
      const videoList = document.getElementById("videoList");
      const container = document.createElement("div");
      container.classList.add("video-item");
      container.innerHTML = `
        <video controls src="${url}"></video>
        <a href="${url}" download>Download Video</a>
      `;
      videoList.prepend(container);
    }
  </script>
</body>
</html>
